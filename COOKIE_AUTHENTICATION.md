# 쿠키 기반 인증(Cookie-Based Authentication) 동작 원리

이 문서는 웹 애플리케이션에서 쿠키를 사용한 인증 방식이 어떻게 작동하는지 단계별로 설명합니다.

---

## 핵심 요약

1.  **로그인:** 사용자가 ID/PW로 로그인하면, 서버는 인증 정보를 담은 **쿠키**를 생성하여 브라우저에 보냅니다. (`Set-Cookie` 헤더)
2.  **쿠키 저장:** 브라우저는 서버로부터 받은 쿠키를 자동으로 자신의 저장소에 저장합니다.
3.  **인증 요청:** 이후 해당 서버로 API를 요청할 때마다, 브라우저는 저장된 쿠키를 **자동으로** 요청에 포함하여 보냅니다. (`Cookie` 헤더)
4.  **서버 검증:** 서버는 요청에 담겨온 쿠키를 검증하여 사용자가 인증된 사용자인지 확인하고, 결과를 응답합니다.

이 모든 과정은 `axios` 인스턴스에 `withCredentials: true` 옵션을 설정함으로써 원활하게 작동합니다.

---

## 상세 동작 과정

### 1단계: 로그인 및 쿠키 발급 (서버 → 브라우저)

1.  사용자가 로그인 폼에 아이디와 비밀번호를 입력하고 제출합니다.
2.  프론트엔드에서는 `axios` 같은 HTTP 클라이언트를 사용해 백엔드 로그인 API(`POST /api/login`)를 호출합니다.
3.  백엔드 서버는 데이터베이스 등에서 사용자 정보를 확인하여 유효한 자격 증명인지 검증합니다.
4.  검증에 성공하면, 서버는 **세션(Session)**을 생성하고, 이 세션을 식별할 수 있는 고유한 ID(Session ID)를 만듭니다.
5.  서버는 이 Session ID를 담은 쿠키를 생성한 뒤, HTTP 응답(Response)의 **`Set-Cookie`** 헤더에 실어 프론트엔드로 전송합니다.

    ```http
    HTTP/1.1 200 OK
    Set-Cookie: session_id=a1b2c3d4e5f6; HttpOnly; Path=/; Max-Age=3600
    Content-Type: application/json
    ```

### 2단계: 쿠키 저장 (브라우저의 역할)

1.  웹 브라우저는 서버로부터 받은 응답에 `Set-Cookie` 헤더가 포함된 것을 인지합니다.
2.  브라우저는 이 헤더의 내용을 바탕으로 쿠키를 자신의 **쿠키 저장소(Cookie Jar)**에 **자동으로 저장**합니다.
3.  이때 쿠키는 어떤 서버(도메인)에서 발급했는지, 어떤 경로에서 유효한지, 만료 기한은 언제인지 등의 정보와 함께 저장됩니다.
    -   `HttpOnly` 옵션이 있으면 자바스크립트로 쿠키에 접근하는 것을 막아 XSS(Cross-Site Scripting) 공격을 방지하는 데 도움이 됩니다.

### 3단계: 다음 API 요청 (프론트엔드 → 서버)

1.  사용자가 로그인 후, '내 정보 보기'나 '장바구니 보기'처럼 인증이 필요한 페이지/기능을 요청합니다.
2.  프론트엔드 코드는 백엔드의 특정 API(`GET /api/me`)를 호출합니다.
3.  요청을 보내기 직전, 브라우저는 다음을 확인합니다:
    *   "이 요청, `http://myserver.com`으로 가는 거네?"
    *   "내 쿠키 저장소를 보니, `myserver.com` 도메인으로 설정된 쿠키가 있구나!"
4.  브라우저는 해당 쿠키를 **자동으로** HTTP 요청(Request)의 **`Cookie`** 헤더에 담아서 서버로 전송합니다.

    ```http
    GET /api/me HTTP/1.1
    Host: myserver.com
    Cookie: session_id=a1b2c3d4e5f6
    ```

### 4단계: 서버의 인증 및 응답 (서버의 역할)

1.  서버는 API 요청을 받고, 요청 헤더에 `Cookie`가 포함되어 있는지 확인합니다.
2.  쿠키에 담겨온 `session_id` 값을 추출하여, 서버 측 세션 저장소에 해당 ID를 가진 세션이 있는지 조회합니다.
3.  세션이 존재하고 유효하다면, 서버는 "아, 이 사용자는 이전에 인증을 마친 유효한 사용자구나!"라고 판단합니다.
4.  서버는 요청받은 작업을 수행하고(예: 사용자 정보 조회), 그 결과를 응답으로 보내줍니다.
5.  만약 쿠키가 없거나, `session_id`가 유효하지 않다면, 서버는 "인증되지 않은 사용자입니다(401 Unauthorized)"와 같은 에러를 응답합니다.

---

## 핵심 설정: `withCredentials: true`

이 모든 자동화된 과정이 원활하게 작동하기 위한 **가장 중요한 전제 조건**은 `axios`와 같은 HTTP 클라이언트에서 `withCredentials: true` 옵션을 설정하는 것입니다.

-   **왜 필요한가?**: 기본적으로 웹 브라우저의 보안 정책(Same-Origin Policy)에 따라, 다른 출처(Cross-Origin)로 요청을 보낼 때는 쿠키와 같은 인증 정보를 자동으로 보내지 않습니다. (예: 프론트엔드 `localhost:5173` ↔ 백엔드 `localhost:3000`는 포트가 달라 Cross-Origin에 해당)

-   **무슨 역할을 하는가?**: `withCredentials: true` 옵션은 브라우저에게 "이 요청은 다른 출처로 가지만, 내가 신뢰하는 곳이니 쿠키를 포함해서 보내줘!"라고 명시적으로 알려주는 신호입니다.

`axios` 인스턴스를 생성할 때 이 옵션을 기본값으로 설정해두면, 모든 API 요청에 해당 설정이 적용되어 편리합니다.

```javascript
// src/api/axios.ts
import axios from 'axios';

const apiClient = axios.create({
  baseURL: 'http://localhost:3000', // 백엔드 서버 주소
  withCredentials: true, // 쿠키 자동 전송을 위한 기본 설정
});

export default apiClient;
```
